<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>MCP Server Workflow Manager</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link 
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" 
      rel="stylesheet"
    />
    <style>
      body {
        min-height: 100vh;
        display: flex;
        align-items: flex-start;
        background-color: #f8f9fa;
        padding: 2rem 0;
      }
      .app-container {
        min-height: calc(100vh - 4rem);
        max-width: 1400px;
        margin: 0 auto;
        width: 100%;
        padding: 0 2rem;
      }
      .card {
        border: 1px solid rgba(0,0,0,.125);
        box-shadow: 0 2px 4px rgba(0,0,0,.05);
      }
      .card-header {
        background-color: #f8f9fa;
        border-bottom: 1px solid rgba(0,0,0,.125);
      }
      .card-body {
        padding: 1.5rem;
        background-color: white;
      }
      pre {
        white-space: pre-wrap;
        word-wrap: break-word;
      }
      select.form-select {
        cursor: pointer;
      }
      select.form-select option {
        cursor: pointer;
        padding: 8px;
      }
      select.form-select option:hover {
        background-color: #f8f9fa;
      }
      #chat-messages {
        height: calc(100vh - 250px);
        min-height: 400px;
        overflow-y: auto;
        padding: 1rem;
        border-radius: 0.5rem;
        background-color: rgba(248, 249, 250, 0.5);
      }
      .chat-message {
        margin-bottom: 1rem;
        padding: 1rem;
        border-radius: 0.75rem;
        max-width: 80%;
        box-shadow: 0 1px 2px rgba(0,0,0,.05);
      }
      .user-message {
        background-color: #e9ecef;
        margin-left: auto;
        border-bottom-right-radius: 0.25rem;
      }
      .assistant-message {
        background-color: #e3f2fd;
        margin-right: auto;
        border-bottom-left-radius: 0.25rem;
      }
      .system-message {
        background-color: rgba(248, 249, 250, 0.8);
        text-align: center;
        padding: 0.75rem;
        margin-bottom: 1rem;
        max-width: 100%;
        border-radius: 0.5rem;
        font-size: 0.9rem;
        color: #6c757d;
      }
      .chat-input-area {
        background-color: #fff;
      }
      .error-message {
        color: #dc3545;
      }
      .chat-toggle {
        position: fixed;
        bottom: 20px;
        right: 20px;
        z-index: 1050;
        display: none;
      }
      @media (max-width: 768px) {
        .chat-toggle {
          display: flex;
          align-items: center;
          justify-content: center;
          width: 48px;
          height: 48px;
          font-size: 1.25rem;
          box-shadow: 0 2px 8px rgba(0,0,0,.15);
        }
        .chat-sidebar {
          position: fixed;
          top: 0;
          right: -100%;
          width: 100%;
          height: 100vh;
          background: white;
          z-index: 1040;
          transition: all 0.3s ease-in-out;
          overflow-y: auto;
          padding: 1rem;
        }
        .chat-sidebar.active {
          right: 0;
          box-shadow: -4px 0 8px rgba(0,0,0,.1);
        }
        .chat-close {
          position: absolute;
          top: 1rem;
          right: 1rem;
          z-index: 1;
          font-size: 1.1rem;
        }
        .app-container {
          padding: 1rem;
        }
        .card {
          margin-bottom: 1rem;
        }
        #chat-messages {
          height: calc(100vh - 200px);
        }
      }
    </style>
  </head>
  <body>
    <div class="app-container">
      <div class="container-fluid p-0">
        <h1 class="mb-4 text-center">T-Dub's MCP Server Workflow Manager</h1>

        <div class="row">
        <!-- Left Column: Workflow Controls -->
        <div class="col-md-8">
          <!-- Workflow Selection -->
          <div class="card mb-4">
            <div class="card-header">
              <h5 class="card-title mb-0">Select Workflow</h5>
            </div>
            <div class="card-body">
              <select
                id="workflowSelect"
                title="workflow-select"
                class="form-select mb-3"
              >
                <option value="">Choose a workflow...</option>
              </select>
            </div>
          </div>

          <!-- GitHub Repository Section -->
          <div class="card mb-4">
            <div class="card-header">
              <h5 class="card-title mb-0">GitHub Repository</h5>
            </div>
            <div class="card-body">
              <label for="repoSelect" class="form-label"
                >Select Repository</label
              >
              <select
                id="repoSelect"
                title="repository-select"
                class="form-select mb-3"
              >
                <option value="">Choose a repository...</option>
              </select>
            </div>
          </div>

          <!-- Status Section -->
          <div class="card mb-4">
            <div class="card-header">
              <h5 class="card-title mb-0">Current Status</h5>
            </div>
            <div class="card-body">
              <pre id="status" class="bg-light p-3 rounded"></pre>
            </div>
          </div>
        </div>

        <!-- Right Column: Chat Interface -->
        <div class="col-md-4 chat-sidebar">
          <div class="card h-100">
            <div class="card-header d-flex justify-content-between align-items-center">
              <h5 class="card-title mb-0">AI Assistant</h5>
              <div>
                <button id="setContext" class="btn btn-primary" disabled>
                  Start Session
                </button>
                <button class="btn btn-link chat-close d-md-none">
                  <i class="fas fa-times"></i> Close
                </button>
              </div>
            </div>
            <div class="card-body d-flex flex-column">
              <!-- Chat Messages -->
              <div id="chat-messages" class="flex-grow-1 overflow-auto mb-3 p-3">
                <div class="system-message text-muted">
                  Select a workflow and repository to begin.
                </div>
              </div>

              <!-- Chat Input -->
              <div class="chat-input-area p-3 border-top">
                <div class="input-group">
                  <input
                    type="text"
                    id="messageInput"
                    class="form-control"
                    placeholder="Type your message..."
                    disabled
                  />
                  <button id="sendMessage" class="btn btn-primary" disabled>
                    Send
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Mobile Chat Toggle -->
        <button class="btn btn-primary rounded-circle chat-toggle" id="chatToggle">
          <i class="fas fa-comment"></i>
        </button>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script>
      // Variables
      const statusDisplay = document.getElementById("status");
      const workflowSelect = document.getElementById("workflowSelect");
      const repoSelect = document.getElementById("repoSelect");
      const chatMessages = document.getElementById("chat-messages");
      const messageInput = document.getElementById("messageInput");
      const sendButton = document.getElementById("sendMessage");
      const setContextButton = document.getElementById("setContext");

      let currentSessionId = null;

      // Fetch and populate workflows
      async function fetchWorkflows() {
        try {
          const response = await axios.get("/workflows");
          response.data.workflows.forEach((workflow) => {
            const option = document.createElement("option");
            option.value = workflow;
            option.textContent = workflow;
            workflowSelect.appendChild(option);
          });
        } catch (error) {
          console.error("Error fetching workflows:", error);
        }
      }

      // Add message to chat
      function addMessage(type, content) {
        const messageDiv = document.createElement("div");
        messageDiv.className = `chat-message ${type}-message`;
        messageDiv.textContent = content;
        chatMessages.appendChild(messageDiv);
        chatMessages.scrollTop = chatMessages.scrollHeight;
      }

      // Update status and check if we can enable chat
      function updateSelections() {
        const workflow = workflowSelect.value;
        const repo = repoSelect.value;
        let status = "Current Selections:\n";
        status += workflow
          ? `Workflow: ${workflow}\n`
          : "No workflow selected\n";
        status += repo ? `Repository: ${repo}` : "No repository selected";
        statusDisplay.textContent = status;

        // Enable/disable chat controls
        const canStartSession = workflow && repo;
        setContextButton.disabled = !canStartSession;
      }

      // Show loading state
      function setLoading(isLoading) {
        runWorkflowButton.disabled = isLoading;
        runWorkflowButton.innerHTML = isLoading
          ? '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Running...'
          : "Run Workflow";
      }

      // Fetch and populate repositories
      async function fetchRepositories() {
        try {
          repoSelect.disabled = true;
          const response = await axios.get("/github/repos");
          repoSelect.innerHTML =
            '<option value="">Choose a repository...</option>';

          response.data.forEach((repo) => {
            const option = document.createElement("option");
            option.value = repo.full_name;
            option.textContent = repo.full_name;
            repoSelect.appendChild(option);
          });
        } catch (error) {
          console.error("Error fetching repositories:", error);
          textResults.textContent =
            "Error: " + error.response?.data?.error || error.message;
          textResults.classList.add("text-danger");
        } finally {
          repoSelect.disabled = false;
        }
      }

      // Run workflow with selected repository
      async function runWorkflow() {
        const workflow = workflowSelect.value;
        const repo = repoSelect.value;

        if (!workflow || !repo) {
          textResults.classList.add("text-danger");
          textResults.textContent =
            "Please select both a workflow and a repository";
          return;
        }

        try {
          setLoading(true);
          const response = await axios.post("/run-workflow", {
            workflow,
            repository: repo,
          });
          textResults.classList.remove("text-danger");
          textResults.textContent = JSON.stringify(response.data, null, 2);
        } catch (error) {
          console.error("Error running workflow:", error);
          textResults.classList.add("text-danger");
          textResults.textContent =
            "Error: " + error.response?.data?.error || error.message;
        } finally {
          setLoading(false);
        }
      }

      // Start chat session
      async function startSession() {
        const workflow = workflowSelect.value;
        const repo = repoSelect.value;
        const [owner, name] = repo.split("/");

        try {
          setContextButton.disabled = true;
          setContextButton.innerHTML =
            '<span class="spinner-border spinner-border-sm"></span> Starting...';

          const response = await axios.post("/set-context", {
            workflow,
            owner,
            repo: name,
          });

          currentSessionId = response.data.sessionId;

          // Enable chat controls
          messageInput.disabled = false;
          sendButton.disabled = false;
          setContextButton.style.display = "none";

          // Clear previous messages and add system message
          chatMessages.innerHTML = "";
          addMessage(
            "system",
            "Session started! You can now chat about the selected workflow and repository."
          );
        } catch (error) {
          console.error("Error starting session:", error);
          addMessage(
            "system",
            "Error: Failed to start session. Please try again."
          );
          setContextButton.disabled = false;
        }
        setContextButton.innerHTML = "Start Session";
      }

      // Send message to AI
      async function sendMessage() {
        const message = messageInput.value.trim();
        if (!message || !currentSessionId) return;

        try {
          // Add user message to chat
          addMessage("user", message);
          messageInput.value = "";
          sendButton.disabled = true;

          // Send to AI
          const response = await axios.post("/ai-interact", {
            sessionId: currentSessionId,
            message,
          });

          // Add AI response to chat
          addMessage("assistant", JSON.stringify(response.data, null, 2));
        } catch (error) {
          console.error("Error sending message:", error);
          addMessage(
            "system",
            "Error: Failed to send message. Please try again."
          );
        }
        sendButton.disabled = false;
      }

      // Toggle mobile chat
      function toggleChat() {
        const chatSidebar = document.querySelector('.chat-sidebar');
        chatSidebar.classList.toggle('active');
      }

      // Event listeners
      workflowSelect.addEventListener("change", updateSelections);
      repoSelect.addEventListener("change", updateSelections);
      setContextButton.addEventListener("click", startSession);
      sendButton.addEventListener("click", sendMessage);
      messageInput.addEventListener("keypress", (e) => {
        if (e.key === "Enter" && !e.shiftKey) {
          e.preventDefault();
          sendMessage();
        }
      });

      // Mobile chat toggle
      document.getElementById('chatToggle')?.addEventListener('click', toggleChat);
      document.querySelector('.chat-close')?.addEventListener('click', toggleChat);

      // Initialize
      fetchWorkflows();
      fetchRepositories();
      updateSelections();
    </script>
  </body>
</html>
